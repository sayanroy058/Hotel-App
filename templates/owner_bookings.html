{% extends "base.html" %}

{% block title %}Bookings Management - {{ session.username }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-calendar-alt"></i> Bookings Management</h2>
            <a href="{{ url_for('add_booking') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Booking
            </a>
        </div>
    </div>
</div>

<!-- Booking Filters -->
<div class="row mb-4">
    <div class="col-md-4">
        <input type="text" class="form-control" id="searchBookings" placeholder="Search by guest name, email, or phone...">
    </div>
    <div class="col-md-2">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="confirmed">Confirmed</option>
            <option value="cancelled">Cancelled</option>
        </select>
    </div>
    <div class="col-md-2">
        <select class="form-select" id="paymentFilter">
            <option value="">All Payments</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
        </select>
    </div>
    <div class="col-md-2">
        <input type="date" class="form-control" id="dateFilter" placeholder="Check-in date">
    </div>
    <div class="col-md-2">
        <button class="btn btn-outline-secondary" onclick="clearFilters()">
            <i class="fas fa-times"></i> Clear
        </button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if bookings %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="bookingsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Guest Details</th>
                                <th>Room</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Guests</th>
                                <th>Amount</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in bookings %}
                            <tr>
                                <td><strong>#{{ booking[0] }}</strong></td>
                                <td>
                                    <div><strong>{{ booking[1] }}</strong></div>
                                    {% if booking[2] %}
                                        <small class="text-muted">{{ booking[2] }}</small><br>
                                    {% endif %}
                                    {% if booking[3] %}
                                        <small class="text-muted">{{ booking[3] }}</small>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-info">{{ booking[4] }}</span></td>
                                <td>{{ booking[5] }}</td>
                                <td>{{ booking[6] }}</td>
                                <td>{{ booking[7] }}</td>
                                <td><strong>₹{{ "%.2f"|format(booking[8]) }}</strong></td>
                                <td>
                                    {% if booking[9] == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if booking[10] == 'confirmed' %}
                                        <span class="badge bg-success">Confirmed</span>
                                    {% else %}
                                        <span class="badge bg-danger">Cancelled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="viewBooking({{ booking[0] }})" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if booking[10] == 'confirmed' %}
                                        <a href="{{ url_for('edit_booking', booking_id=booking[0]) }}" 
                                           class="btn btn-sm btn-outline-warning" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% if booking[9] == 'pending' %}
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="markAsPaid({{ booking[0] }})" title="Mark as Paid">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="cancelBooking({{ booking[0] }})" title="Cancel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                    <h4>No Bookings Found</h4>
                    <p class="text-muted">Start by creating your first booking.</p>
                    <a href="{{ url_for('add_booking') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create First Booking
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Booking Statistics -->
{% if bookings %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ bookings|length }}</h4>
                <p class="mb-0">Total Bookings</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ bookings|selectattr(10, 'equalto', 'confirmed')|list|length }}</h4>
                <p class="mb-0">Confirmed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ bookings|selectattr(9, 'equalto', 'pending')|list|length }}</h4>
                <p class="mb-0">Pending Payment</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>₹{{ "%.0f"|format(bookings|selectattr(9, 'equalto', 'paid')|map(attribute=8)|sum) }}</h4>
                <p class="mb-0">Total Revenue</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Booking Details Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookingModalBody">
                <!-- Booking details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search and filter functionality
document.getElementById('searchBookings').addEventListener('input', function() {
    filterTable();
});

document.getElementById('statusFilter').addEventListener('change', function() {
    filterTable();
});

document.getElementById('paymentFilter').addEventListener('change', function() {
    filterTable();
});

document.getElementById('dateFilter').addEventListener('change', function() {
    filterTable();
});

function filterTable() {
    const searchTerm = document.getElementById('searchBookings').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const paymentFilter = document.getElementById('paymentFilter').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    
    const rows = document.querySelectorAll('#bookingsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const statusCell = row.cells[8].textContent.toLowerCase();
        const paymentCell = row.cells[7].textContent.toLowerCase();
        const checkinDate = row.cells[3].textContent;
        
        let show = true;
        
        if (searchTerm && !text.includes(searchTerm)) {
            show = false;
        }
        
        if (statusFilter && !statusCell.includes(statusFilter)) {
            show = false;
        }
        
        if (paymentFilter && !paymentCell.includes(paymentFilter)) {
            show = false;
        }
        
        if (dateFilter && checkinDate !== dateFilter) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('searchBookings').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('paymentFilter').value = '';
    document.getElementById('dateFilter').value = '';
    filterTable();
}

function viewBooking(bookingId) {
    fetch(`/owner/bookings/${bookingId}/details`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('bookingModalBody').innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        });
}

function markAsPaid(bookingId) {
    if (confirm('Mark this booking as paid?')) {
        fetch(`/owner/bookings/${bookingId}/mark-paid`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating payment status');
            }
        });
    }
}

function cancelBooking(bookingId) {
    if (confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
        fetch(`/owner/bookings/${bookingId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error cancelling booking');
            }
        });
    }
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Documents - {{ guest_name }} - Booking #{{ booking_id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('owner_bookings') }}">Bookings</a></li>
                <li class="breadcrumb-item active">Documents - {{ guest_name }}</li>
            </ol>
        </nav>
        
        <h2><i class="fas fa-file-alt"></i> Guest Documents</h2>
        <p class="text-muted">Manage documents for {{ guest_name }} - Booking #{{ booking_id }}</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Upload New Document -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-upload"></i> Upload New Document</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="document_type" class="form-label">Document Type *</label>
                                <select class="form-select" id="document_type" name="document_type" required>
                                    <option value="">Choose document type</option>
                                    <option value="passport">Passport</option>
                                    <option value="national_id">National ID</option>
                                    <option value="driving_license">Driving License</option>
                                    <option value="voter_id">Voter ID</option>
                                    <option value="other">Other ID</option>
                                </select>
                                <div class="invalid-feedback">Please select document type.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="document_id" class="form-label">Document ID/Number *</label>
                                <input type="text" class="form-control" id="document_id" name="document_id" 
                                       placeholder="Enter document ID or number" required>
                                <div class="invalid-feedback">Please enter document ID.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="document" class="form-label">Select File *</label>
                        <input type="file" class="form-control" id="document" name="document" 
                               accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx" required>
                        <div class="form-text">
                            Supported formats: PDF, JPG, PNG, GIF, DOC, DOCX. Maximum size: 5MB
                        </div>
                        <div class="invalid-feedback">Please select a file to upload.</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Document
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Existing Documents -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Uploaded Documents</h5>
                <span class="badge bg-secondary">{{ documents|length }} documents</span>
            </div>
            <div class="card-body">
                {% if documents %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Document Type</th>
                                <th>Document ID</th>
                                <th>File Name</th>
                                <th>Size</th>
                                <th>Uploaded</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documents %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{ doc.document_type.title() }}</span>
                                </td>
                                <td>
                                    <code>{{ doc.document_id }}</code>
                                </td>
                                <td>
                                    <small>{{ doc.file_name }}</small>
                                </td>
                                <td>
                                    <small>{{ "%.1f"|format(doc.file_size / 1024) }} KB</small>
                                </td>
                                <td>
                                    <small>{{ doc.uploaded_at }}</small>
                                </td>
                                <td>
                                    {% if doc.is_verified %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Verified
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('download_document', document_id=doc.id) }}" 
                                           class="btn btn-outline-primary" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        
                                        {% if doc.is_verified %}
                                        <button class="btn btn-outline-warning" 
                                                onclick="toggleVerification({{ doc.id }}, false)" title="Mark as Unverified">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-success" 
                                                onclick="toggleVerification({{ doc.id }}, true)" title="Mark as Verified">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteDocument({{ doc.id }}, '{{ doc.document_type }}')" 
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No documents uploaded yet</h5>
                    <p class="text-muted">Upload guest documents using the form above.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Document Guidelines -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Document Guidelines</h5>
            </div>
            <div class="card-body">
                <h6>Accepted Document Types</h6>
                <ul class="small">
                    <li>Passport</li>
                    <li>National ID Card</li>
                    <li>Driving License</li>
                    <li>Voter ID Card</li>
                    <li>Other Government ID</li>
                </ul>
                
                <h6>File Requirements</h6>
                <ul class="small">
                    <li>Maximum file size: 5MB</li>
                    <li>Supported formats: PDF, JPG, PNG, GIF, DOC, DOCX</li>
                    <li>Clear, readable images</li>
                    <li>All text should be visible</li>
                </ul>
                
                <h6>Smart Document Detection</h6>
                <p class="small text-muted">
                    The system automatically detects if a document ID already exists and prevents duplicate uploads.
                </p>
            </div>
        </div>
        
        <!-- Document Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Document Status</h5>
            </div>
            <div class="card-body">
                {% set verified_count = documents | selectattr('is_verified') | list | length %}
                {% set pending_count = documents | length - verified_count %}
                
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success">{{ verified_count }}</h4>
                        <p class="mb-0 small">Verified</p>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">{{ pending_count }}</h4>
                        <p class="mb-0 small">Pending</p>
                    </div>
                </div>
                
                {% if documents %}
                <div class="progress mt-3">
                    {% set verification_rate = (verified_count / documents|length * 100) %}
                    <div class="progress-bar bg-success" style="width: {{ verification_rate }}%">
                        {{ "%.0f"|format(verification_rate) }}% Verified
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if documents %}
                    <button class="btn btn-success btn-sm" onclick="verifyAllDocuments()">
                        <i class="fas fa-check-double"></i> Verify All Documents
                    </button>
                    {% endif %}
                    
                    <a href="{{ url_for('owner_bookings') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to Bookings
                    </a>
                    
                    <a href="{{ url_for('manage_documents') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list"></i> All Documents
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleVerification(documentId, verified) {
    fetch(`/owner/documents/${documentId}/verify`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ verified: verified })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error updating document verification');
    });
}

function deleteDocument(documentId, documentType) {
    if (confirm(`Are you sure you want to delete this ${documentType} document?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/owner/documents/${documentId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

function verifyAllDocuments() {
    if (confirm('Mark all documents as verified?')) {
        const unverifiedDocs = document.querySelectorAll('button[onclick*="toggleVerification"][onclick*="true"]');
        unverifiedDocs.forEach(button => {
            const onclick = button.getAttribute('onclick');
            const documentId = onclick.match(/toggleVerification\((\d+),/)[1];
            toggleVerification(parseInt(documentId), true);
        });
    }
}

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// File size validation
document.getElementById('document').addEventListener('change', function() {
    const file = this.files[0];
    if (file && file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        this.value = '';
    }
});
</script>

{% endblock %}
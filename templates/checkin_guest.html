{% extends "base.html" %}

{% block title %}Check-in - {{ booking[1] }} - Room {{ booking[3] }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('owner_checkin_checkout') }}">Check-in/Check-out</a></li>
                <li class="breadcrumb-item active">Check-in - {{ booking[1] }}</li>
            </ol>
        </nav>
        
        <h2><i class="fas fa-sign-in-alt"></i> Guest Check-in</h2>
        <p class="text-muted">Complete check-in process for {{ booking[1] }}</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Booking Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Booking Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Guest Name:</strong> {{ booking[1] }}</p>
                        <p><strong>Room Number:</strong> {{ booking[3] }}</p>
                        <p><strong>Guest Count:</strong> {{ booking[2] }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Check-in Date:</strong> {{ booking[4] }}</p>
                        <p><strong>Booking ID:</strong> #{{ booking[0] }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Document Verification Status -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-file-check"></i> Document Verification</h5>
                <a href="{{ url_for('booking_documents', booking_id=booking[0]) }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-upload"></i> Manage Documents
                </a>
            </div>
            <div class="card-body">
                {% if documents %}
                <div class="row">
                    <div class="col-md-8">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Document Type</th>
                                        <th>Document ID</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for doc in documents %}
                                    <tr>
                                        <td>{{ doc.document_type.title() }}</td>
                                        <td><code>{{ doc.document_id }}</code></td>
                                        <td>
                                            {% if doc.is_verified %}
                                                <span class="badge bg-success">Verified</span>
                                            {% else %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('download_document', document_id=doc.id) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-4">
                        {% set verified_count = documents | selectattr('is_verified') | list | length %}
                        {% set verification_rate = (verified_count / documents|length * 100) %}
                        
                        <div class="text-center">
                            <h4 class="text-primary">{{ verified_count }}/{{ documents|length }}</h4>
                            <p class="mb-2">Documents Verified</p>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ verification_rate }}%">
                                    {{ "%.0f"|format(verification_rate) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>No documents uploaded yet!</strong>
                    <p class="mb-0">
                        Guest documents are required for check-in. 
                        <a href="{{ url_for('booking_documents', booking_id=booking[0]) }}" class="alert-link">
                            Upload documents now
                        </a>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Check-in Form -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clipboard-check"></i> Complete Check-in</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="notes" class="form-label">Check-in Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Any special notes or observations during check-in..."></textarea>
                    </div>
                    
                    <!-- Document Verification Checklist -->
                    {% if documents %}
                    <div class="mb-3">
                        <label class="form-label">Document Verification Checklist</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="documents_verified" required>
                            <label class="form-check-label" for="documents_verified">
                                I have verified all uploaded documents and they are authentic
                            </label>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="room_ready" required>
                            <label class="form-check-label" for="room_ready">
                                Room {{ booking[3] }} is clean and ready for occupancy
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="guest_informed" required>
                            <label class="form-check-label" for="guest_informed">
                                Guest has been informed about hotel policies and amenities
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('owner_checkin_checkout') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        
                        <button type="submit" class="btn btn-success btn-lg" 
                                {% if not documents %}disabled title="Upload documents first"{% endif %}>
                            <i class="fas fa-check"></i> Complete Check-in
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Document Requirements -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list-check"></i> Document Requirements</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    For {{ booking[2] }} guest(s), the following documents are typically required:
                </p>
                
                <ul class="small">
                    {% for i in range(booking[2]) %}
                    <li>Guest {{ i + 1 }}: Valid ID proof (Passport, National ID, etc.)</li>
                    {% endfor %}
                </ul>
                
                <div class="alert alert-info alert-sm">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Smart Document Check:</strong> The system automatically detects if a document ID already exists and prevents duplicate uploads.
                </div>
            </div>
        </div>
        
        <!-- Check-in Guidelines -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-clipboard-list"></i> Check-in Guidelines</h5>
            </div>
            <div class="card-body">
                <h6>Before Check-in:</h6>
                <ul class="small">
                    <li>Verify all guest documents</li>
                    <li>Ensure room is clean and ready</li>
                    <li>Check payment status</li>
                    <li>Prepare room keys/cards</li>
                </ul>
                
                <h6>During Check-in:</h6>
                <ul class="small">
                    <li>Welcome the guest warmly</li>
                    <li>Explain hotel policies</li>
                    <li>Provide WiFi details</li>
                    <li>Show amenities location</li>
                </ul>
                
                <h6>After Check-in:</h6>
                <ul class="small">
                    <li>Update room status</li>
                    <li>Send confirmation if needed</li>
                    <li>Note any special requests</li>
                </ul>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Document Status</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ uploaded_docs }}</h4>
                        <p class="mb-0 small">Uploaded</p>
                    </div>
                    <div class="col-6">
                        <h4 class="text-muted">{{ required_docs }}</h4>
                        <p class="mb-0 small">Required</p>
                    </div>
                </div>
                
                {% if uploaded_docs < required_docs %}
                <div class="alert alert-warning alert-sm mt-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    {{ required_docs - uploaded_docs }} more document(s) needed
                </div>
                {% elif uploaded_docs >= required_docs %}
                <div class="alert alert-success alert-sm mt-2">
                    <i class="fas fa-check"></i>
                    All required documents uploaded
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Enable/disable check-in button based on document requirements
document.addEventListener('DOMContentLoaded', function() {
    const hasDocuments = {{ 'true' if documents else 'false' }};
    const checkinButton = document.querySelector('button[type="submit"]');
    
    if (!hasDocuments) {
        checkinButton.disabled = true;
        checkinButton.title = 'Upload guest documents first';
    }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const requiredCheckboxes = document.querySelectorAll('input[type="checkbox"][required]');
    let allChecked = true;
    
    requiredCheckboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            allChecked = false;
        }
    });
    
    if (!allChecked) {
        e.preventDefault();
        alert('Please complete all required checks before proceeding with check-in.');
    }
});
</script>

{% endblock %}